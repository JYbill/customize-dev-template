# Actionæ“ä½œåç§°
name: CI

# æƒé™
permissions:
  contents: write

# è§¦å‘äº‹ä»¶
on:
  push:
    branches: [ "main" ] # é’ˆå¯¹mainåˆ†æ”¯
  pull_request:
    branches: [ "main" ]

  # å…è®¸æ‚¨ä»"Actions"é€‰é¡¹å¡æ‰‹åŠ¨è¿è¡Œæ­¤å·¥ä½œæµ
  workflow_dispatch:

# å·¥ä½œæµ
jobs:
  # ä»»åŠ¡"build"
  build:
    runs-on: ubuntu-latest # è¿è¡Œä½œä¸šçš„æœåŠ¡å™¨ç³»ç»Ÿ
    steps: # è¿è¡Œä½œä¸šçš„æœåŠ¡å™¨ç³»ç»Ÿ
      - uses: actions/checkout@v4 # Actionæ’ä»¶(v4ç‰ˆæœ¬)ï¼šå°†ä»“åº“çš„æ‰€æœ‰æ–‡ä»¶éƒ½å¯è¢«è®¿é—®
        # with:
          # é»˜è®¤1ï¼Œ0è¡¨ç¤ºè·å–å®Œæ•´çš„gitå†å²ï¼Œâš ï¸ å½“ä»“åº“è¿‡å¤§æ—¶å¯ä»¥æƒè¡¡æ¯”å¦‚è®¾ç½®ä¸º100ï¼ˆå°±ç®—åœ¨pråº”è¯¥ä¸ä¼šæœ‰äººæäº¤100ä¸ªcommitå§ğŸ˜“ï¼‰
          # fetch-depth: 100
          # ä¸è¦ä¸‹è½½treeæ ‘æ•°æ®ï¼ˆå³fetch-depth: nå±‚çš„çœŸå®ç›®å½•ç»“æ„ï¼‰
          # filter: tree:0

      # å¦‚æœéœ€è¦å°†checkoutçš„ä»£ç æ˜ å°„åˆ°github ciæœåŠ¡å™¨çš„mainåˆ†æ”¯ï¼Œå¯ä»¥è¿™æ ·åšï¼Œæ­¤æ—¶git branchä¼šæ˜¾ç¤ºä¸º"main"å¦åˆ™é»˜è®¤ä¸º"detached HEAD"
      # è¿™å¯¹nx affectedæ—¶å¿…é¡»çš„
      # - name: Check out the default branch
        # run: git branch --track main origin/main

      # setup-nodeæ’ä»¶
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          # æ”¯æŒ: npm, yarn, pnpmï¼Œå°†ç¼“å­˜node_modulesä»¥åŠå¯¹åº”çš„åŒ…ç®¡ç†å·¥å…·çš„ç¼“å­˜ç›®å½•
          cache: 'npm'
      - run: npm ci

      # nrwl/nx-set-shasæ’ä»¶ï¼šç”¨äºåœ¨GitHub Actionç¯å¢ƒä¸‹
      # 1. ç¡®å®š"base"ä¸Šä¸€æ¬¡master/mainä¸»åˆ†æ”¯çš„commit hashå€¼
      # 2. ç¡®å®š"head"å³PRæäº¤çš„æœ€æ–°commit hashå€¼
      # è¿™ä¸¤ç‚¹ç”¨æ¥ä¿è¯"nx affected"èƒ½å¤Ÿæ­£ç¡®è¦†ç›–æ‰€æœ‰å—å½±å“çš„æ–‡ä»¶ï¼Œä»¥åŠnxéœ€è¦æ‰§è¡Œçš„ä¾èµ–å›¾
      # éœ€è¦æƒé™: è¯»å–æƒé™çš„contentsã€actionsã€pull-requests
      - name: check affected commit hash
        uses: nrwl/nx-set-shas@v4
      # æ–¹å¼ä¸€ï¼šä½¿ç”¨ç¯å¢ƒå˜é‡çš„è¯»å–æ–¹å¼
        # env.NX_BASE: base
        # env.NX_HEAD: head
      - run: |
          echo "BASE: ${{ env.NX_BASE }}"
          echo "HEAD: ${{ env.NX_HEAD }}"
      # æ–¹å¼äºŒï¼šä½¿ç”¨æ­¥éª¤çš„è¯»å–æ–¹å¼
      # ç»™è¿™ä¸ªæ­¥éª¤è®¾ç½®idï¼Œæ–¹ä¾¿ä¸‹é¢çš„è¯»å–
      #   id: setSHAs
      # - run: |
      #     echo "BASE: ${{ steps.setSHAs.outputs.base }}"
      #     echo "HEAD: ${{ steps.setSHAs.outputs.head }}"

      # éƒ¨ç½²æ­¥éª¤
      - name: Deploy ğŸš€
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          folder: deploy # ä»“åº“å†…éœ€è¦éƒ¨ç½²çš„ç›®å½•ï¼Œä¸”ä¸ä¼šéƒ¨ç½²`.gitignore`å†…çš„æ–‡ä»¶
          branch: deploy # éƒ¨ç½²åˆ°deployåˆ†æ”¯
          commit-message: "deploy: push config or rules through action"